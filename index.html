<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Асоціативний аналіз</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-primary: #0d9488; /* Teal-600 */
            --brand-secondary: #f0fdfa; /* Teal-50 */
            --brand-light: #ccfbf1; /* Teal-100 */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .method-panel { display: none; }
        .method-panel.active { display: block; }
        
        .tab-btn {
            padding: 0.75rem 1rem; font-weight: 600; color: #4b5563;
            border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap;
        }
        .tab-btn.active { color: var(--brand-primary); border-bottom-color: var(--brand-primary); }
        .tabs-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tabs-container::-webkit-scrollbar { display: none; }

        .btn-primary { background-color: var(--brand-primary); color: white; transition: background-color 0.2s; }
        .btn-primary:hover:not(:disabled) { background-color: #0f766e; }
        .btn-primary:disabled { background-color: #5eead4; cursor: not-allowed; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #cbd5e1; }

        @media (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tr {
                display: block; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;
                border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); background-color: white;
            }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0.25rem; text-align: right; border-bottom: 1px solid #f3f4f6; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; text-align: left; padding-right: 1rem; color: #374151; }
            .responsive-table .input-narrow, .responsive-table input[type="text"] { width: 60%; text-align: right; }
        }
        .table-cell { padding: 12px 10px; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .toast {
            position: fixed; top: 20px; right: 20px; background-color: #22c55e; color: white;
            padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0; transition: all 0.3s; transform: translateY(-20px); z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .mismatch-row { background-color: #fefce8; }
        #dream-description-editor, #amplification-words { min-height: 128px; padding: 0.75rem; outline: none; }
        #dream-description-editor strong { background-color: var(--brand-light); font-weight: 600; padding: 1px 3px; border-radius: 3px; }
        
        .assoc16-input { border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.75rem; width: 100%; text-align: center; font-size: 1rem; transition: all 0.2s; }
        .assoc16-input:focus { border-color: var(--brand-primary); box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.3); }

        .home-btn {
            position: absolute; top: 1rem; right: 1rem; z-index: 10;
            background-color: #f3f4f6; color: #4b5563; border-radius: 9999px; width: 2.5rem; height: 2.5rem;
            display: flex; align-items: center; justify-content: center; transition: background-color 0.2s;
        }
        .home-btn:hover { background-color: #e5e7eb; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        .progress-bar { background-color: #e2e8f0; border-radius: 9999px; overflow: hidden; }
        .progress-bar-inner { background-color: var(--brand-primary); height: 0.5rem; border-radius: 9999px; transition: width 0.3s; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen py-4 sm:py-8">
    <div class="w-full max-w-7xl mx-auto p-4 sm:p-6 md:p-8" id="main-content">
        <!-- Screens are rendered here by JS -->
    </div>
    <div id="toast-message" class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContainer = document.getElementById('main-content');
            const toastMessage = document.getElementById('toast-message');
            const homeButtonSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5ZM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5 5 5Z"/></svg>`;

            // --- State Variables ---
            let wordList = [], currentWordIndex = 0, results = [], startTime, testPhase = 'run1', baseReactionTime = 0;
            const NEUTRAL_WORDS = ['Стіл', 'Вода', 'Лампа', 'Книга', 'Дорога', 'Дерево', 'Скло', 'Крісло', 'Папір', 'Хмара'];
            const JUNG_WORDS = ['Голова','Зелений','Вода','Співати','Мертвий','Довгий','Корабель','Платити','Вікно','Дружній','Готувати','Запитати','Застуда','Стебло','Танцювати','Село','Озеро','Хворий','Гордість','Чорнила','Злий','Голка','Плавати','Подорож','Синій','Лампа','Гріх','Хліб','Багаті','Дерево','Колоти','Жалість','Жовтий','Гора','Померти','Сіль','Новий','Звичай','Молитися','Гроші','Безглуздий','Брошура','Зневажати','Палець','Дорогий','Птах','Впасти','Книга','Несправедливий','Жаба','Розділяти','Голод','Білий','Дитина','Дбати','Олівець','Сумний','Слива','Одружуватися','Дім','Коханий','Скло','Сваритися','Хутро','Великий','Морква','Малювати','Частина','Старий','Квітка','Бути','Коробка','Дикий','Родина','Мити','Корова','Друг','Везіння','Брехня','Поведінка','Вузький','Брат','Боятися','Лелека','Фальшивий','Тривога','Цілувати','Наречена','Чистий','Двері','Вибирати','Сіно','Задоволений','Висміювати','Спати','Місяць','Хороший','Жінки','Зловживати'];
            const CALIBRATION_COUNT = 3;
            let assoc16Data = [[], [], [], [], []];
            let currentStep16 = 0;
            let topicValue = '', descriptionHTML = '', wordInputValue = '';

            // --- Core Functions ---
            function showToast(message) {
                toastMessage.textContent = message; toastMessage.classList.add('show');
                setTimeout(() => { toastMessage.classList.remove('show'); }, 2000);
            }
            
            function createHomeButton() {
                const homeBtn = document.createElement('button');
                homeBtn.className = 'home-btn'; homeBtn.innerHTML = homeButtonSVG; homeBtn.title = 'На головну';
                homeBtn.addEventListener('click', renderSetupScreen);
                return homeBtn;
            }

            function renderScreen(content) {
                mainContainer.innerHTML = ''; mainContainer.appendChild(content);
            }

            function copyToClipboard(text, message) {
                navigator.clipboard.writeText(text).then(() => showToast(message), () => showToast('Помилка копіювання'));
            }
            
            // --- SETUP SCREEN ---
            function renderSetupScreen() {
                const screen = document.createElement('div');
                const freePanelHTML = `<div class="card p-6 md:p-8"><div class="grid md:grid-cols-2 gap-8"><div><label for="analysis-topic" class="block text-sm font-medium text-slate-700 mb-2">Тема аналізу:</label><input type="text" id="analysis-topic" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="Сон, ситуація, відчуття..."><div class="mt-6"><label class="block text-sm font-medium text-slate-700 mb-2">1. Опишіть вашу тему:</label><div class="border border-slate-300 rounded-lg"><div class="p-2 border-b bg-slate-50 rounded-t-lg"><button id="bold-btn" class="font-bold text-lg px-3 py-1 rounded hover:bg-slate-200" title="Виділити слово (Ctrl+B)">B</button><span class="text-xs text-slate-500 ml-2">Виділіть текст та натисніть 'B'.</span></div><div id="dream-description-editor" contenteditable="true" class="w-full p-3 outline-none"></div></div></div></div><div><div class="flex justify-between items-center mb-2"><label for="word-input" class="block text-sm font-medium text-slate-700">2. Слова-стимули:</label><button id="load-jung-words-btn" class="text-xs bg-teal-50 text-teal-700 font-semibold py-1 px-3 rounded-full hover:bg-teal-100">100 слів Юнга</button></div><textarea id="word-input" rows="10" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Виділяйте слова в описі або додавайте їх сюди вручну..."></textarea></div></div><div class="mt-8 text-center"><button id="start-association-test-btn" class="w-full sm:w-auto btn-primary font-semibold py-3 px-8 rounded-lg shadow-md">Розпочати тест</button></div></div>`;
                const assoc16PanelHTML = `<div class="card text-center p-6 md:p-8 max-w-2xl mx-auto"><p class="text-slate-600 mb-4">Цей метод допомагає знайти несвідоме рішення для конкретної проблеми. Сформулюйте її одним словом або короткою фразою.</p><label for="problem-word-input" class="block text-sm font-medium text-slate-700 mb-2">Ваша проблема / Запит:</label><input type="text" id="problem-word-input" class="w-full max-w-md mx-auto p-3 text-center border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="Наприклад: Прокрастинація, Стосунки, Пошук себе"><div class="mt-8"><button id="start-16-associations-btn" class="w-full sm:w-auto btn-primary font-semibold py-3 px-8 rounded-lg shadow-md">Почати "16 Асоціацій"</button></div></div>`;
                screen.innerHTML = `<header class="text-center mb-8"><div class="flex justify-center items-center gap-3 text-3xl sm:text-4xl font-bold text-gray-900"><svg class="h-8 w-8 text-teal-600" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/><path d="M12 12C13.6569 12 15 10.6569 15 9C15 7.34315 13.6569 6 12 6C10.3431 6 9 7.34315 9 9C9 10.6569 10.3431 12 12 12Z" stroke="currentColor" stroke-width="2"/><path d="M7 17C7.61667 15.6667 9.8 14 12 14C14.2 14 16.3833 15.6667 17 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><h1>Асоціативний аналіз</h1></div><p class="text-slate-500 mt-2">Ваш ключ до несвідомого</p></header><div class="max-w-xl mx-auto mb-8"><div class="flex justify-center border-b tabs-container"><button class="tab-btn active" data-method="free-analysis">Вільний аналіз</button><button class="tab-btn" data-method="16-associations">16 Асоціацій</button></div></div><div id="free-analysis-panel" class="method-panel active">${freePanelHTML}</div><div id="16-associations-panel" class="method-panel">${assoc16PanelHTML}</div>`;
                renderScreen(screen);
                document.getElementById('analysis-topic').value = topicValue;
                document.getElementById('dream-description-editor').innerHTML = descriptionHTML;
                document.getElementById('word-input').value = wordInputValue;
                screen.querySelector('#load-jung-words-btn').addEventListener('click', () => { screen.querySelector('#word-input').value = JUNG_WORDS.join('\n'); });
                screen.querySelector('#start-association-test-btn').addEventListener('click', startAssociationTest);
                screen.querySelector('#bold-btn').addEventListener('click', handleBoldClick);
                screen.querySelector('#start-16-associations-btn').addEventListener('click', start16Associations);
                const tabButtons = screen.querySelectorAll('.tab-btn');
                const methodPanels = screen.querySelectorAll('.method-panel');
                tabButtons.forEach(button => button.addEventListener('click', () => { tabButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); methodPanels.forEach(panel => panel.id === `${button.dataset.method}-panel` ? panel.classList.add('active') : panel.classList.remove('active')); }));
            }

            function handleBoldClick() {
                const selection = window.getSelection(); if (!selection.rangeCount || selection.isCollapsed) return;
                const selectedText = selection.toString().trim().replace(/\s+/g, ' '); if (!selectedText) return;
                document.execCommand('bold', false, null);
                const wordInput = document.getElementById('word-input');
                const currentWords = wordInput.value.split('\n').map(w => w.trim()).filter(Boolean);
                if (!currentWords.includes(selectedText)) { wordInput.value += (wordInput.value ? '\n' : '') + selectedText; }
            }
            
            // --- ASSOCIATION TEST (Free/Classic) ---
            function startAssociationTest() {
                topicValue = document.getElementById('analysis-topic').value;
                descriptionHTML = document.getElementById('dream-description-editor').innerHTML;
                wordInputValue = document.getElementById('word-input').value;
                const userWords = [...new Set(wordInputValue.trim().split('\n').filter(word => word.trim() !== ''))];
                if (userWords.length === 0) { showToast('Будь ласка, додайте хоча б одне слово-стимул.'); return; }
                const calibrationWords = [...NEUTRAL_WORDS].sort(() => 0.5 - Math.random()).slice(0, CALIBRATION_COUNT);
                wordList = [...calibrationWords, ...userWords];
                currentWordIndex = 0;
                results = wordList.map((stimulus, index) => ({ stimulus, association1: '', reactionTime1: 0, association2: '', reactionTime2: 0, userFlagged: false, emotion: '', feeling: '', comment: '', isCalibration: index < CALIBRATION_COUNT }));
                testPhase = 'run1'; runAssocTestPhase();
            }

            function runAssocTestPhase() {
                const isRetest = testPhase === 'retest';
                currentWordIndex = isRetest ? CALIBRATION_COUNT : 0;
                const screen = document.createElement('div');
                screen.className = 'card p-4 sm:p-8 max-w-2xl mx-auto relative';
                screen.appendChild(createHomeButton());
                screen.innerHTML += `<p id="test-phase-title" class="text-lg font-semibold text-teal-600 mb-4 text-center"></p><h2 id="stimulus-word" class="text-4xl md:text-5xl font-bold mb-8 h-20 flex items-center justify-center break-words px-2 text-center"></h2><div class="relative max-w-md mx-auto"><input type="text" id="association-input" class="w-full text-center p-4 border-2 border-slate-300 rounded-lg text-xl" autocomplete="off"><p class="absolute -bottom-6 right-0 text-sm text-slate-400">Натисніть Enter</p></div><div id="progress-indicator" class="mt-12 text-slate-500 text-center"></div>`;
                renderScreen(screen);
                screen.querySelector('#association-input').addEventListener('keydown', handleAssocSubmit);
                screen.querySelector('#test-phase-title').textContent = isRetest ? 'Етап 2: Повторна асоціація' : 'Етап 1: Калібрування та перший прохід';
                displayNextAssocWord();
            }

            function displayNextAssocWord() {
                if (currentWordIndex < wordList.length) {
                    document.getElementById('stimulus-word').textContent = wordList[currentWordIndex];
                    const progressText = results[currentWordIndex].isCalibration ? `Калібрування ${currentWordIndex + 1} з ${CALIBRATION_COUNT}` : `Слово ${currentWordIndex - CALIBRATION_COUNT + 1} з ${wordList.length - CALIBRATION_COUNT}`;
                    document.getElementById('progress-indicator').textContent = progressText;
                    const input = document.getElementById('association-input');
                    input.value = ''; input.focus(); startTime = Date.now();
                } else {
                    if (testPhase === 'run1') {
                        const screen = document.createElement('div');
                        screen.className = 'card p-8 max-w-2xl mx-auto relative text-center';
                        screen.appendChild(createHomeButton());
                        screen.innerHTML += `<h1 class="text-2xl sm:text-3xl font-bold text-slate-900">Основний етап завершено</h1><p class="mt-4 mb-6 max-w-lg mx-auto text-slate-600">Тепер знову ті самі слова (без калібрувальних). Спробуйте відтворити першу асоціацію.</p><button id="start-retest-btn-dynamic" class="btn-primary font-semibold py-3 px-8 rounded-lg">Почати повторний тест</button>`;
                        renderScreen(screen);
                        screen.querySelector('#start-retest-btn-dynamic').addEventListener('click', () => { testPhase = 'retest'; runAssocTestPhase(); });
                    } else { endAssocTest(); }
                }
            }
            
            function handleAssocSubmit(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const reactionTime = parseFloat(((Date.now() - startTime) / 1000).toFixed(2));
                    const association = event.target.value.trim();
                    if (association === '') { showToast('Будь ласка, введіть асоціацію.'); return; }
                    const currentResult = results[currentWordIndex];
                    if (testPhase === 'run1') { currentResult.association1 = association; currentResult.reactionTime1 = reactionTime; } 
                    else if (!currentResult.isCalibration) { currentResult.association2 = association; currentResult.reactionTime2 = reactionTime; }
                    currentWordIndex++; displayNextAssocWord();
                }
            }
            
            function endAssocTest() {
                renderAssocResultsScreen();
            }
            
            function renderAssocResultsScreen() {
                 const screen = document.createElement('div');
                 screen.className = 'card p-6 md:p-8 relative';
                 screen.appendChild(createHomeButton());
                 const interpretationGuideHTML = `<div class="bg-slate-50 p-6 rounded-lg border"><h3 class="text-xl font-bold mb-4">Як інтерпретувати результати? Поглиблений посібник</h3><p class="mb-4 text-gray-600">Цей тест — не іспит, а дзеркало. Він підсвічує емоційно заряджені теми (<strong class="text-gray-800">комплекси</strong>) у вашій психіці.</p><h4 class="text-lg font-semibold mt-6 mb-3">Крок 1: Знайдіть індикатори комплексів</h4><p class="mb-3 text-gray-600">Програма автоматично позначає (*) аномалії, спираючись на персоналізовану для вас логіку.</p><ul class="space-y-3 list-disc list-inside"><li><strong class="text-gray-800">Розбіжність асоціацій:</strong> Найважливіший маркер. Вказує на сильний несвідомий заряд теми.</li><li><strong class="text-gray-800">Довгий час реакції:</strong> Програма обчислює вашу середню швидкість. Значно довша реакція вказує на внутрішню боротьбу.</li><li><strong class="text-gray-800">Сильні емоції та тілесні реакції:</strong> Прямі сигнали, що ви торкнулися чогось значущого.</li></ul><h4 class="text-lg font-semibold mt-6 mb-3">Крок 2: Працюйте з виявленими комплексами</h4><ul class="space-y-3 list-disc list-inside text-gray-700"><li><strong>Ампліфікація:</strong> Розширте образ (міфи, казки, мистецтво).</li><li><strong>Активна уява:</strong> Уявіть символ і почніть з ним діалог.</li><li><strong>Зв'язок з реальним життям:</strong> Як тема пов'язана з вашими поточними обставинами?</li></ul><p class="mt-6 text-sm text-gray-500 border-t pt-4"><strong>Застереження:</strong> Цей інструмент призначений для самодослідження. Якщо теми викликають сильний дискомфорт, зверніться до психотерапевта.</p></div>`;
                 screen.innerHTML = `<h1 id="final-title-assoc" class="text-2xl sm:text-3xl font-bold text-center mb-4"></h1><div class="bg-slate-50 p-4 rounded-lg border mb-6"><h3 class="text-lg font-semibold text-slate-800 mb-2">Опис теми:</h3><div id="final-dream-description-assoc" class="text-slate-600 whitespace-pre-wrap"></div></div><div class="overflow-x-auto mb-8"><table class="w-full text-left border-collapse text-sm responsive-table"><thead><tr><th class="table-cell font-semibold bg-slate-50">Стимул</th><th class="table-cell font-semibold bg-slate-50">Асоціація 1</th><th class="table-cell font-semibold bg-slate-50 text-center">Час</th><th class="table-cell font-semibold bg-slate-50">Асоціація 2</th><th class="table-cell font-semibold bg-slate-50 text-center">Час</th><th class="table-cell font-semibold bg-slate-50 text-center">Розбіжність</th><th class="table-cell font-semibold bg-slate-50 text-center">*</th><th class="table-cell font-semibold bg-slate-50">Емоції</th><th class="table-cell font-semibold bg-slate-50">Відчуття</th><th class="table-cell font-semibold bg-slate-50">Коментар</th></tr></thead><tbody id="results-table-body-assoc"></tbody></table></div><div class="mb-8"><div class="flex flex-col sm:flex-row items-center justify-between mb-2 gap-2"><label class="block text-sm font-medium text-slate-700">Ключові слова для роботи:</label><div class="flex items-center"><input id="include-details-checkbox-assoc" type="checkbox" checked class="h-4 w-4 text-teal-600 border-slate-300 rounded"><label for="include-details-checkbox-assoc" class="ml-2 block text-sm">Додавати деталі</label></div></div><div class="relative"><div id="amplification-words-assoc" contenteditable="true" class="w-full border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-teal-500 min-h-[128px] p-3 font-mono text-sm"></div><button id="copy-amplification-btn-assoc" class="absolute top-2 right-3 bg-slate-200 text-slate-700 font-semibold py-1 px-3 rounded-full text-xs hover:bg-slate-300">Копіювати</button></div></div>${interpretationGuideHTML}<div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4"><button id="copy-md-btn-assoc" class="btn-primary font-semibold py-3 px-6 rounded-lg w-full sm:w-auto">Копіювати звіт (MD)</button><button id="export-csv-btn-assoc" class="btn-secondary font-semibold py-3 px-6 rounded-lg w-full sm:w-auto">Експортувати в CSV</button><button id="restart-btn-assoc" class="btn-secondary font-semibold py-3 px-6 rounded-lg w-full sm:w-auto">Пройти ще раз</button></div>`;
                 renderScreen(screen);
                 displayAssocResults(screen);
            }

            function displayAssocResults(screen) {
                screen.querySelector('#final-title-assoc').textContent = topicValue ? `Результати: ${topicValue}` : 'Результати аналізу';
                screen.querySelector('#final-dream-description-assoc').innerHTML = descriptionHTML;
                const calibrationTimes = results.filter(r => r.isCalibration).map(r => r.reactionTime1);
                baseReactionTime = calibrationTimes.reduce((a, b) => a + b, 0) / calibrationTimes.length || 2;
                const longTimeThreshold = baseReactionTime * 1.75;
                const tableHeaders = ['Стимул', 'Асоціація 1', 'Час', 'Асоціація 2', 'Час', 'Розбіжність', '*', 'Емоції', 'Відчуття', 'Коментар'];
                const tableBody = screen.querySelector('#results-table-body-assoc');
                tableBody.innerHTML = '';
                results.forEach((result, index) => {
                    if (result.isCalibration) return;
                    const mismatch = result.association1.toLowerCase().trim() !== result.association2.toLowerCase().trim();
                    const longTime = result.reactionTime1 > longTimeThreshold || result.reactionTime2 > longTimeThreshold;
                    if(mismatch || longTime) result.userFlagged = true;
                    
                    const row = document.createElement('tr');
                    row.className = `hover:bg-gray-50 ${mismatch ? 'mismatch-row' : ''}`;
                    row.innerHTML = `
                        <td data-label="${tableHeaders[0]}" class="table-cell font-semibold">${result.stimulus}</td>
                        <td data-label="${tableHeaders[1]}" class="table-cell">${result.association1}</td>
                        <td data-label="${tableHeaders[2]}" class="table-cell text-center font-mono ${longTime && result.reactionTime1 > longTimeThreshold ? 'text-red-500 font-bold' : ''}">${result.reactionTime1.toFixed(2)}</td>
                        <td data-label="${tableHeaders[3]}" class="table-cell">${result.association2}</td>
                        <td data-label="${tableHeaders[4]}" class="table-cell text-center font-mono ${longTime && result.reactionTime2 > longTimeThreshold ? 'text-red-500 font-bold' : ''}">${result.reactionTime2.toFixed(2)}</td>
                        <td data-label="${tableHeaders[5]}" class="table-cell text-center font-semibold ${mismatch ? 'text-red-600' : 'text-green-600'}">${mismatch ? 'Так' : 'Ні'}</td>
                        <td data-label="${tableHeaders[6]}" class="table-cell text-center"><input type="checkbox" data-index="${index}" data-field="userFlagged" class="result-input-assoc h-5 w-5 text-teal-600" ${result.userFlagged ? 'checked' : ''}></td>
                        <td data-label="${tableHeaders[7]}" class="table-cell"><input type="text" data-index="${index}" data-field="emotion" class="result-input-assoc input-narrow w-full p-1 border rounded-md" value="${result.emotion}"></td>
                        <td data-label="${tableHeaders[8]}" class="table-cell"><input type="text" data-index="${index}" data-field="feeling" class="result-input-assoc input-narrow w-full p-1 border rounded-md" value="${result.feeling}"></td>
                        <td data-label="${tableHeaders[9]}" class="table-cell"><input type="text" data-index="${index}" data-field="comment" class="result-input-assoc input-narrow w-full p-1 border rounded-md" value="${result.comment}"></td>
                    `;
                    tableBody.appendChild(row);
                });
                
                screen.querySelectorAll('.result-input-assoc').forEach(input => {
                    input.addEventListener(input.type === 'checkbox' ? 'change' : 'input', e => {
                        const { index, field } = e.target.dataset;
                        results[parseInt(index)][field] = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                        updateAmplificationList(screen);
                    });
                });
                screen.querySelector('#include-details-checkbox-assoc').addEventListener('change', () => updateAmplificationList(screen));
                screen.querySelector('#copy-md-btn-assoc').addEventListener('click', () => copyToClipboard(generateReportContent('md', screen), 'Звіт скопійовано!'));
                screen.querySelector('#export-csv-btn-assoc').addEventListener('click', () => exportAssocToCSV(screen));
                screen.querySelector('#restart-btn-assoc').addEventListener('click', renderSetupScreen);
                screen.querySelector('#copy-amplification-btn-assoc').addEventListener('click', () => { 
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = screen.querySelector('#amplification-words-assoc').innerHTML.replace(/<div>/g, '\n').replace(/<\/div>/g, '');
                    const textToCopy = tempDiv.textContent.trim();
                    if (textToCopy) copyToClipboard(textToCopy, 'Ключові слова скопійовано!'); 
                });
                updateAmplificationList(screen);
            }

            function updateAmplificationList(screen) {
                let content = '';
                const includeDetails = screen.querySelector('#include-details-checkbox-assoc').checked;
                results.forEach(result => {
                    if (result.userFlagged && !result.isCalibration) {
                        const stimulusText = `<strong>${result.stimulus}</strong>`;
                        const assoc1 = result.association1.toLowerCase().trim();
                        const assoc2 = result.association2.toLowerCase().trim();
                        const associationText = assoc1 === assoc2 || !assoc2 ? `${result.association1}` : `${result.association1} / ${result.association2}`;
                        let details = [];
                        if (includeDetails) {
                            if (result.emotion) details.push(`Емоція: ${result.emotion}`);
                            if (result.feeling) details.push(`Відчуття: ${result.feeling}`);
                            if (result.comment) details.push(`Коментар: ${result.comment}`);
                        }
                        let detailsString = details.length > 0 ? ` <em>[${details.join(' | ')}]</em>` : '';
                        content += `<div>${stimulusText} → ${associationText}${detailsString}</div>`;
                    }
                });
                screen.querySelector('#amplification-words-assoc').innerHTML = content;
            }

            function generateReportContent(format, screen) {
                const ampWordsDiv = screen.querySelector('#amplification-words-assoc');
                let ampWordsRaw = '';
                if(ampWordsDiv) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = ampWordsDiv.innerHTML.replace(/<div>/g, '\n').replace(/<\/div>/g, '');
                    ampWordsRaw = tempDiv.textContent.trim();
                }

                if (format === 'md') {
                    const ampWordsMd = ampWordsDiv ? ampWordsDiv.innerHTML.replace(/<strong>/g, '**').replace(/<\/strong>/g, '**').replace(/<em>/g, '*').replace(/<\/em>/g, '*').replace(/<\/div><div>/g, '\n').replace(/<div>/g, '').replace(/<\/div>/g, '') : '';
                    let content = `# Аналіз: ${topicValue || 'Без назви'}\n\n## Опис\n${descriptionHTML ? document.createElement('div').innerHTML = descriptionHTML : 'Не заповнено.'}\n\n## Ключові комплекси\n\`\`\`\n${ampWordsMd || 'Немає'}\n\`\`\`\n\n## Результати тесту\n\n`;
                    const headers = ['Стимул', 'Асоціація 1', 'Час', 'Асоціація 2', 'Час', 'Розбіжність', '*', 'Емоції', 'Відчуття', 'Коментар'];
                    content += `| ${headers.join(' | ')} |\n|---|---|:---:|---|:---:|:---:|:---:|---|---|---|\n`;
                    results.filter(r => !r.isCalibration).forEach(r => {
                        const mismatch = r.association1.toLowerCase().trim() !== r.association2.toLowerCase().trim() ? '**Так**' : 'Ні';
                        const flagged = r.userFlagged ? '✓' : '';
                        const row = [r.stimulus, r.association1, r.reactionTime1.toFixed(2), r.association2, r.reactionTime2.toFixed(2), mismatch, flagged, r.emotion, r.feeling, r.comment];
                        content += `| ${row.map(s => String(s || '').replace(/\|/g, '\\|')).join(' | ')} |\n`;
                    });
                    return content;
                } else { // CSV
                    const escapeCsvField = (field) => `"${String(field || '').replace(/"/g, '""')}"`;
                    let content = `Тема аналізу:\n${escapeCsvField(topicValue)}\nОпис:\n${escapeCsvField(descriptionHTML)}\nКлючові комплекси:\n${escapeCsvField(ampWordsRaw)}\n\n`;
                    const headers = ['Стимул', 'Асоціація 1', 'Час 1', 'Асоціація 2', 'Час 2', 'Розбіжність', '*', 'Емоції', 'Відчуття', 'Коментар'];
                    content += headers.map(h => escapeCsvField(h)).join(',') + '\n';
                    results.filter(r => !r.isCalibration).forEach(r => {
                        const mismatch = r.association1.toLowerCase().trim() !== r.association2.toLowerCase().trim() ? 'Так' : 'Ні';
                        const flagged = r.userFlagged ? 'Так' : 'Ні';
                        const row = [r.stimulus, r.association1, r.reactionTime1, r.reactionTime2, mismatch, flagged, r.emotion, r.feeling, r.comment];
                        content += row.map(field => escapeCsvField(field)).join(',') + '\n';
                    });
                    return content;
                }
            }

            function exportAssocToCSV(screen) {
                const content = generateReportContent('csv', screen);
                const blob = new Blob([`\uFEFF${content}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob); link.download = "associative_analysis.csv";
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
            
            // --- 16 ASSOCIATIONS ---
            function start16Associations() {
                const problemWord = document.getElementById('problem-word-input').value.trim();
                if (!problemWord) { showToast('Будь ласка, введіть проблему або запит.'); return; }
                assoc16Data = [[], [], [], [], []]; currentStep16 = 0; renderAssoc16Step(problemWord);
            }
            
            function renderAssoc16Step(problemWord) {
                const screen = document.createElement('div');
                screen.className = 'card p-6 md:p-8 max-w-3xl mx-auto relative';
                screen.appendChild(createHomeButton());
                const stepInfo = [ { count: 16, title: "Крок 1 з 5: Введіть 16 асоціацій до вашої теми" }, { count: 8, title: "Крок 2 з 5: Об'єднайте кожну пару в нову асоціацію" }, { count: 4, title: "Крок 3 з 5: Продовжуйте об'єднувати пари" }, { count: 2, title: "Крок 4 з 5: Майже у мети" }, { count: 1, title: "Крок 5 з 5: Знайдіть фінальну асоціацію" } ];
                const currentInfo = stepInfo[currentStep16];
                let inputsHTML = '';
                if (currentStep16 === 0) {
                    for(let i=0; i<16; i++) { inputsHTML += `<div class="flex items-center gap-2"><span class="text-slate-400 w-6 text-right">${i + 1}.</span><input type="text" class="assoc16-input" data-index="${i}"></div>`; }
                } else {
                    for(let i=0; i<currentInfo.count; i++) {
                        const parent1 = assoc16Data[currentStep16-1][i*2]; const parent2 = assoc16Data[currentStep16-1][i*2+1];
                        inputsHTML += `<div class="flex items-center gap-4"><div class="w-2/5 text-right"><div class="p-2 bg-slate-100 rounded text-slate-600">${parent1}</div><div class="p-2 bg-slate-100 rounded mt-2 text-slate-600">${parent2}</div></div><div class="w-1/5 text-center text-slate-300 text-2xl">→</div><div class="w-2/5"><input type="text" class="assoc16-input" data-index="${i}"></div></div>`;
                    }
                }
                screen.innerHTML += `<div class="text-center mb-6"><h1 class="text-2xl font-bold text-slate-900">Тема: ${problemWord}</h1><p class="text-slate-500 mt-2">${currentInfo.title}</p></div><div class="w-full progress-bar mt-4 mb-6"><div class="progress-bar-inner" style="width: ${((currentStep16 + 1) / 5) * 100}%"></div></div><div class="grid ${currentStep16 === 0 ? 'grid-cols-2 sm:grid-cols-4' : 'grid-cols-1'} gap-4">${inputsHTML}</div><div class="text-center mt-8"><button id="assoc16-next-btn" class="btn-primary font-semibold py-3 px-8 rounded-lg">Далі</button></div>`;
                renderScreen(screen);
                screen.querySelector('#assoc16-next-btn').addEventListener('click', () => handleAssoc16Next(problemWord));
            }

            function handleAssoc16Next(problemWord) {
                const inputs = Array.from(mainContainer.querySelectorAll('.assoc16-input'));
                const values = inputs.map(input => input.value.trim());
                if (values.some(v => v === '')) { showToast('Будь ласка, заповніть усі поля.'); return; }
                assoc16Data[currentStep16] = values; currentStep16++;
                if (currentStep16 < 5) { renderAssoc16Step(problemWord); } else { renderAssoc16Results(problemWord); }
            }

            function renderAssoc16Results(problemWord) {
                const screen = document.createElement('div');
                screen.className = 'card p-6 md:p-8 max-w-4xl mx-auto relative';
                screen.appendChild(createHomeButton());
                const keyWord = assoc16Data[4][0];
                let pyramidHTML = '<div class="flex flex-col items-center gap-4 text-center text-sm p-4 overflow-x-auto">';
                assoc16Data.forEach((level, i) => {
                    pyramidHTML += `<div class="flex flex-wrap justify-center gap-2 ${i < 4 ? 'mb-2' : ''}">`;
                    level.forEach(word => { pyramidHTML += `<span class="bg-slate-100 rounded px-2 py-1">${word}</span>`; });
                    pyramidHTML += `</div>`;
                });
                pyramidHTML += '</div>';
                screen.innerHTML += `<h1 class="text-2xl sm:text-3xl font-bold text-center mb-4">Результат методу "16 Асоціацій"</h1><div class="text-center mb-6 bg-slate-50 p-6 rounded-lg"><p class="text-slate-600">Ваш запит:</p><p class="text-xl font-semibold">${problemWord}</p><p class="text-slate-600 mt-4">Ключове слово з несвідомого:</p><p class="text-4xl font-bold text-teal-600">${keyWord}</p></div><h3 class="font-semibold text-center mb-2">Ваш шлях асоціацій:</h3>${pyramidHTML}<div class="mt-6"><label class="block text-sm font-medium text-slate-700 mb-2">Ваші висновки та рефлексії:</label><textarea id="assoc16-conclusion" class="w-full p-3 border rounded-lg min-h-[128px]" placeholder="Що це ключове слово означає для вас у контексті вашого запиту? Які нові думки та почуття воно викликає?"></textarea></div><div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4"><button id="copy-16-assoc-report-btn" class="btn-primary font-semibold py-3 px-6 rounded-lg w-full sm:w-auto">Копіювати звіт (MD)</button><button id="restart-16-assoc-btn" class="btn-secondary font-semibold py-3 px-6 rounded-lg w-full sm:w-auto">Почати заново</button></div>`;
                renderScreen(screen);
                screen.querySelector('#restart-16-assoc-btn').addEventListener('click', renderSetupScreen);
                screen.querySelector('#copy-16-assoc-report-btn').addEventListener('click', () => {
                    const conclusion = document.getElementById('assoc16-conclusion').value;
                    let report = `# 16 Асоціацій: ${problemWord}\n\n## Ключове слово: ${keyWord}\n\n## Шлях асоціацій:\n`;
                    assoc16Data.forEach((level, i) => { report += `Крок ${i+1}: ${level.join(', ')}\n`; });
                    report += `\n## Висновки:\n${conclusion || 'Не заповнено.'}`;
                    copyToClipboard(report, 'Звіт "16 Асоціацій" скопійовано!');
                });
            }
            
            // Initial Load
            renderSetupScreen();
        });
    </script>
</body>
</html>

